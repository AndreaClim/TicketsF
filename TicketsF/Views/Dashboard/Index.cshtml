@model TicketsF.Models.DashboardData

@{
    ViewData["Title"] = "Panel de Empleado - TechSoluciones";
    Layout = "_LayoutD";
}

<div class="container mt-4 mb-5">
    <ul class="nav nav-tabs" id="empleadoTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">Dashboard</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="clientes-tab" data-bs-toggle="tab" data-bs-target="#clientes" type="button" role="tab">Clientes</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tickets-tab" data-bs-toggle="tab" data-bs-target="#tickets" type="button" role="tab">Tickets</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="usuarios-tab" data-bs-toggle="tab" data-bs-target="#usuarios" type="button" role="tab">Usuarios</button>
        </li>
    </ul>

    <div class="tab-content bg-dark p-4 rounded-bottom text-white" id="empleadoTabsContent">
        <!-- DASHBOARD -->
        <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
            <div id="dashboard-content">
                <h4 class="mb-4">Dashboard</h4>
                <div class="row text-center mb-4">
                    <div class="col-md-4">
                        <div class="card bg-success text-white shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Tickets Resueltos</h5>
                                <p>@Model.TicketsResueltos</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-warning text-dark shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">En Progreso</h5>
                                <p>@Model.TicketsEnProgreso</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-danger text-white shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Tickets Abiertos</h5>
                                <p>@Model.TicketsAbiertos</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CLIENTES -->
        <div class="tab-pane fade" id="clientes" role="tabpanel">
            <h4>Gestión de Clientes</h4>
            <table class="table table-dark table-striped table-hover">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Correo</th>
                        <th>Teléfono</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var cliente in Model.Clientes)
                    {
                        <tr>
                            <td>@cliente.nombre</td>
                            <td>@cliente.correo</td>
                            <td>@cliente.telefono</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="editUsuario(@cliente.id_usuario)">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteItem(@cliente.id_usuario)">
                                    <i class="fas fa-trash-alt"></i> Eliminar
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- TICKETS -->
        <div class="tab-pane fade" id="tickets" role="tabpanel">
            <h4 class="mb-4">Tickets Activos</h4>
            <table class="table table-dark table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Cliente</th>
                        <th>Descripción</th>
                        <th>Prioridad</th>
                        <th>Estado</th>
                        <th>Asignado a</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var ticket in Model.Tickets)
                    {
                        <tr id="ticket-row-@ticket.id_ticket">
                            <td>@ticket.id_ticket</td>
                            <td>@ticket.usuarioC.nombre</td>
                            <td>@ticket.descripcion</td>
                            <td>
                                <select class="form-select" id="prioridad_@ticket.id_ticket">
                                    @foreach (var prioridad in Model.Prioridades)
                                    {
                                        <option value="@prioridad.id_prioridad" selected="@(ticket.id_prioridad == prioridad.id_prioridad)">
                                            @prioridad.nombre
                                        </option>
                                    }
                                </select>
                            </td>
                            <td>
                                <select class="form-select" id="estado_@ticket.id_ticket">
                                    @foreach (var estado in Model.Estado)
                                    {
                                        <option value="@estado.id_estado" selected="@(ticket.id_estado == estado.id_estado)">
                                            @estado.nombre
                                        </option>
                                    }
                                </select>
                            </td>
                            <td>
                                <select class="form-select" id="usuarioE_@ticket.id_ticket">
                                    @foreach (var usuario in Model.Usuarios.Where(u => u.roles != "Cliente"))
                                    {
                                        <option value="@usuario.id_usuario" selected="@(ticket.id_usuarioE == usuario.id_usuario)">
                                            @usuario.nombre
                                        </option>
                                    }
                                </select>
                            </td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-danger" onclick="deleteItem(@ticket.id_ticket)">
                                        <i class="fas fa-trash-alt"></i> Eliminar
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="resolverTicket(@ticket.id_ticket)">
                                        <i class="fas fa-rotate"></i> Actualizar
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- USUARIOS -->
        <div class="tab-pane fade" id="usuarios" role="tabpanel">
            <h4>Administración de Usuarios</h4>
            <table class="table table-dark table-striped table-hover">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Correo</th>
                        <th>Teléfono</th>
                        <th>Autenticación</th>
                        <th>Roles</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var usuario in Model.Usuarios)
                    {
                        <tr>
                            <td>@usuario.nombre</td>
                            <td>@usuario.correo</td>
                            <td>@usuario.telefono</td>
                            <td>@usuario.autenticacion</td>
                            <td>@usuario.roles</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="editUsuario(@usuario.id_usuario)">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteItem(@usuario.id_usuario)">
                                    <i class="fas fa-trash-alt"></i> Eliminar
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    function resolverTicket(id) {
        var idUsuarioAsignado = document.getElementById('usuarioE_' + id).value;
        var idPrioridad = document.getElementById('prioridad_' + id).value;
        var idEstado = document.getElementById('estado_' + id).value;

        $.ajax({
            url: '/Dashboard/ResolverTicket',
            type: 'GET',
            data: {
                id: id,
                idUsuarioAsignado: idUsuarioAsignado,
                idPrioridad: idPrioridad,
                idEstado: idEstado
            },
            success: function (response) {
                $('#ticket-row-' + id).fadeOut(300, function () {
                    $(this).remove();
                });
                $('#dashboard-content').html(response);
            },
            error: function (error) {
                console.log("Error al resolver el ticket:", error);
            }
        });
    }

    function deleteItem(id) {
        if (confirm("¿Estás seguro de que quieres eliminar este elemento?")) {
            window.location.href = `/Dashboard/Eliminar?id=${id}`;
        }
    }
</script>
